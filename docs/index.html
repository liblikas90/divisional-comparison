<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Patent Comparison Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4 bg-light">
  <div class="container">
    <h2 class="mb-4">Patent Comparison Tool</h2>

    <!-- Input Form -->
    <form id="patentForm" class="row g-3">
      <div class="col-md-6">
        <label for="basePatent" class="form-label">Patent to be validated (Base Patent)</label>
        <input type="text" class="form-control" id="basePatent" placeholder="e.g. EP4221222" required>
      </div>
      <div class="col-md-6">
        <label for="comparisonPatents" class="form-label">Comparison Patents (comma-separated)</label>
        <input type="text" class="form-control" id="comparisonPatents" placeholder="e.g. EP2899982,EP3179722" required>
      </div>
      <div class="col-12">
        <button type="submit" class="btn btn-primary">Compare</button>
      </div>
    </form>

    <!-- Results -->
    <div id="resultsContainer" class="mt-5 d-none">
      <h4>Results</h4>
      <table class="table table-bordered table-hover mt-3" id="resultsTable">
        <thead class="table-light">
          <tr>
            <th>Patent Family</th>
            <th>Claims</th>
            <th>Description</th>
            <th>Total</th>
            <th>Ranking</th>
            <th>Breakdown</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>

      <div class="mt-4 p-3 bg-white border rounded">
        <h5><u>Conclusion</u></h5>
        <p id="conclusionText"></p>
      </div>
    </div>
  </div>

  <!-- Modal for breakdown -->
  <div class="modal fade" id="breakdownModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Breakdown for <span id="modalPatent"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <pre id="modalContent" class="text-wrap"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
  const form = document.getElementById('patentForm');
  const resultsContainer = document.getElementById('resultsContainer');
  const resultsBody = document.getElementById('resultsBody');
  const conclusionText = document.getElementById('conclusionText');
  const modalContent = document.getElementById('modalContent');
  const modalPatent = document.getElementById('modalPatent');
  const modal = new bootstrap.Modal(document.getElementById('breakdownModal'));

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const basePatent = document.getElementById('basePatent').value.trim();
    const comparePatents = document.getElementById('comparisonPatents').value.split(',').map(p => p.trim());

    const res = await fetch("https://59gi8v8w2m.execute-api.us-east-1.amazonaws.com/prod/compare", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        base_patent: basePatent,
        comparison_patents: comparePatents
      })
    });

    const data = await res.json();
    const results = data.results;

    results.sort((a, b) => a.total_word_diff - b.total_word_diff);

    resultsBody.innerHTML = "";
    results.forEach((r, i) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${r.patent}</td>
        <td>${r.claims_total_word_diff}</td>
        <td>${r.description_total_word_diff}</td>
        <td>${r.total_word_diff}</td>
        <td>${i + 1}</td>
        <td><button class="btn btn-sm btn-outline-info" onclick='showBreakdown(${JSON.stringify(r)})'>View</button></td>
      `;
      resultsBody.appendChild(row);
    });

    // Add conclusion with best per section
    const bestTotal = results[0];
    const bestClaims = results.reduce((a, b) =>
      a.claims_total_word_diff < b.claims_total_word_diff ? a : b
    );
    const bestDesc = results.reduce((a, b) =>
      a.description_total_word_diff < b.description_total_word_diff ? a : b
    );

    conclusionText.innerHTML = `
      <strong>${bestTotal.patent}</strong> is the most similar patent based on <u>total word difference</u> and should generally be preferred as the reference.<br><br>
      Based on individual sections:<br>
      • Most similar <strong>claims</strong>: ${bestClaims.patent} (${bestClaims.claims_total_word_diff} word difference)<br>
      • Most similar <strong>description</strong>: ${bestDesc.patent} (${bestDesc.description_total_word_diff} word difference)
    `;

    resultsContainer.classList.remove('d-none');
  });

  function showBreakdown(data) {
    modalPatent.textContent = data.patent;
    modalContent.textContent = `
=== DESCRIPTION ===
Total Word Diff: ${data.description_total_word_diff}
New Words: ${data.description_completely_new_words}
Removed Words: ${data.description_completely_removed_words}
Changed Frequency: ${data.description_changed_word_frequency}

=== CLAIMS ===
Total Word Diff: ${data.claims_total_word_diff}
New Words: ${data.claims_completely_new_words}
Removed Words: ${data.claims_completed_removed_words}
Changed Frequency: ${data.claims_changed_word_frequency}
    `.trim();
    modal.show();
  }
</script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
