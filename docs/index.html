<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Divisional Patent Comparison Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #f9f9f9;
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
    }
    .card {
      border-radius: 10px;
      margin-bottom: 30px;
    }
    .section-title {
      font-weight: 700;
      font-size: 1.4rem;
      margin-bottom: 20px;
    }
    .highlight {
      font-weight: bold;
      color: #004085;
    }
    .collapse {
      margin-bottom: 20px;
    }
    #spinner {
      display: none;
    }
  </style>
</head>
<body>
<div class="container">
  <h1 class="text-center mb-4">Divisional Patent Comparison Tool</h1>

  <!-- Error Alert -->
  <div id="errorBox" class="alert alert-danger d-none" role="alert"></div>

  <!-- Input Form -->
  <div class="card p-4">
    <form id="compareForm">
      <div class="row mb-3">
        <label for="basePatent" class="col-sm-3 col-form-label">Base (Customer) Patent:</label>
        <div class="col-sm-9">
          <input type="text" class="form-control" id="basePatent" placeholder="EP4221222" required>
        </div>
      </div>
      <div class="row mb-3">
        <label for="comparePatents" class="col-sm-3 col-form-label">Divisional Patents (comma-separated):</label>
        <div class="col-sm-9">
          <input type="text" class="form-control" id="comparePatents" placeholder="EP2899982,EP3179722,EP3654650" required>
        </div>
      </div>
      <div class="text-end">
        <button type="submit" class="btn btn-primary">Compare</button>
      </div>
    </form>
  </div>

  <!-- Loading Spinner -->
  <div id="spinner" class="text-center my-4">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div class="mt-2">Comparing patents...</div>
  </div>

  <!-- Results Section -->
  <div id="results" class="mt-5 d-none">
    <h3 class="section-title">Results for <span id="basePatentDisplay" class="highlight"></span></h3>

    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>Patent Family</th>
          <th>Description</th>
          <th>Claims</th>
          <th>Total</th>
          <th>Ranking</th>
        </tr>
      </thead>
      <tbody id="resultsTableBody"></tbody>
    </table>

    <h5 class="mt-4 section-title">Conclusion</h5>
    <p id="conclusionText"></p>

    <h5 class="mt-4 section-title">Breakdown</h5>
    <div id="breakdowns"></div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_URL = 'https://59gi8v8w2m.execute-api.us-east-1.amazonaws.com/prod/compare';

  document.getElementById('compareForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const base = document.getElementById('basePatent').value.trim();
    const compsRaw = document.getElementById('comparePatents').value.trim();
    const comps = compsRaw.split(',').map(s => s.trim()).filter(Boolean);

    const errorBox = document.getElementById('errorBox');
    const resultsBox = document.getElementById('results');
    const spinner = document.getElementById('spinner');

    // Reset state
    errorBox.classList.add('d-none');
    errorBox.innerText = '';
    resultsBox.classList.add('d-none');
    spinner.style.display = 'block';

    if (!base || comps.length === 0) {
      spinner.style.display = 'none';
      errorBox.innerText = 'Please enter both a base patent and at least one divisional patent.';
      errorBox.classList.remove('d-none');
      return;
    }

    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ base_patent: base, comparison_patents: comps })
      });

      const data = await response.json();
      spinner.style.display = 'none';

      if (response.status !== 200 || data.error) {
        errorBox.innerText = data.error || 'An unexpected error occurred.';
        errorBox.classList.remove('d-none');
        return;
      }

      const tbody = document.getElementById('resultsTableBody');
      const breakdowns = document.getElementById('breakdowns');
      const baseDisplay = document.getElementById('basePatentDisplay');
      const conclusion = document.getElementById('conclusionText');

      baseDisplay.textContent = base;
      tbody.innerHTML = '';
      breakdowns.innerHTML = '';

      const sorted = [...data.results].sort((a, b) => a.total_word_diff - b.total_word_diff);
      const rankingMap = Object.fromEntries(sorted.map((r, i) => [r.patent, i + 1]));

      const minDesc = data.results.reduce((a, b) => a.description_total_word_diff < b.description_total_word_diff ? a : b).patent;
      const minClaims = data.results.reduce((a, b) => a.claims_total_word_diff < b.claims_total_word_diff ? a : b).patent;
      const minOverall = sorted[0].patent;

      sorted.forEach(r => {
        tbody.innerHTML += `
          <tr>
            <td>${r.patent}</td>
            <td><a href="#break-desc-${r.patent}" class="link-primary" data-bs-toggle="collapse">${r.description_total_word_diff}</a></td>
            <td><a href="#break-claims-${r.patent}" class="link-primary" data-bs-toggle="collapse">${r.claims_total_word_diff}</a></td>
            <td>${r.total_word_diff}</td>
            <td>${rankingMap[r.patent]}</td>
          </tr>
        `;

        breakdowns.innerHTML += `
          <div class="collapse" id="break-desc-${r.patent}">
            <div class="card card-body">
              <strong>Description for ${r.patent}</strong><br>
              Completely new words: ${r.description_completely_new_words}<br>
              Completely removed words: ${r.description_completely_removed_words}<br>
              Changed word frequency: ${r.description_changed_word_frequency}
            </div>
          </div>
          <div class="collapse" id="break-claims-${r.patent}">
            <div class="card card-body">
              <strong>Claims for ${r.patent}</strong><br>
              Completely new words: ${r.claims_completely_new_words}<br>
              Completely removed words: ${r.claims_completed_removed_words}<br>
              Changed word frequency: ${r.claims_changed_word_frequency}
            </div>
          </div>
        `;
      });

      conclusion.innerHTML = `
        The most similar patent in the family overall is <strong>${minOverall}</strong> with the lowest combined word difference.
        The best match for the <strong>description</strong> section is <strong>${minDesc}</strong>
        and for the <strong>claims</strong> section is <strong>${minClaims}</strong>.
      `;

      resultsBox.classList.remove('d-none');

    } catch (err) {
      spinner.style.display = 'none';
      errorBox.innerText = 'Failed to fetch data. Please check your network connection or try again later.';
      errorBox.classList.remove('d-none');
    }
  });
</script>
</body>
</html>
